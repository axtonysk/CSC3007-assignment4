<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <style></style>
</head>
<body>
<svg></svg>
<script src="https://d3js.org/d3.v7.min.js"></script>

<script>

let width = 1000, height = 500;

let svg = d3.select("svg")
    .attr("viewBox", "0 0 " + width + " " + height)

// Load external data
Promise.all([d3.json("links-sample.json"), d3.json("cases-sample.json")]).then(data => {

// Data preprocessing
    data[0].forEach(e => {
        e.source = e.infector;
        e.target = e.infectee;
    });
    
console.log(data[0]); //links
console.log(data[1]); //cases

let linkpath = svg.append("g")
.attr("id", "links")
.selectAll("path")
.data(data[0])
.enter()
.append("path")
.attr("fill", "none")
.attr("stroke", "black");

let node = svg.append("g")
.attr("id", "nodes")
.selectAll("circle")
.data(data[1])
.enter()
.append("circle")
.attr("r", 25)
.style("fill", function (d) {
    if(d.gender=="male") {return 'cornflowerblue'}
    else{ return 'lightpink'}})
.call(d3.drag()
.on("start", dragstarted)
.on("drag", dragged)
.on("end", dragended))

let textLayer = svg.append("g")
.attr("id", "texts")
.selectAll("text")
.data(data[1])
.enter()
.append("text")
.text(function(d) { return d.id })
.attr("font-size", "10px");

let simulation = d3.forceSimulation()
.nodes(data[1])
.force("x", d3.forceX().x( width / 2 ))
.force("y", d3.forceY().y( height /2 ))
.force("link", d3.forceLink(data[0]).id(d => d.id).distance(80))
.force("collide", d3.forceCollide().strength(0.1).radius(50))
.on("tick", d => {
    node
    .attr("cx", d => d.x)
    .attr("cy", d => d.y);

    linkpath
    .attr("d", d => "M" + d.source.x + "," + d.source.y + " " + d.target.x + "," + d.target.y);

    textLayer
    .attr("x", function(d) { return d.x-12 })
    .attr("y", function(d) { return d.y+3 })
});



//console.log(simulation.nodes())
//console.log(simulation.force("link").links())

function dragstarted(event, d) {
  if (!event.active) simulation.alphaTarget(0.3).restart();
  d.fx = d.x;
  d.fy = d.y;
}

function dragged(event, d) {
  d.fx = event.x;
  d.fy = event.y;
}

function dragended(event, d) {
  if (!event.active) simulation.alphaTarget(0);
  d.fx = null;
  d.fy = null;
}

})


</script>

</body>
</html>